var ft=Object.defineProperty;var dt=(o,t,n)=>t in o?ft(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n;var Pe=(o,t,n)=>(dt(o,typeof t!="symbol"?t+"":t,n),n);var We=(o,t,n)=>new Promise((l,r)=>{var s=i=>{try{u(n.next(i))}catch(d){r(d)}},c=i=>{try{u(n.throw(i))}catch(d){r(d)}},u=i=>i.done?l(i.value):Promise.resolve(i.value).then(s,c);u((n=n.apply(o,t)).next())});import{r as a,j as z,a as ht}from"./vendor-35c3d3c5.js";const ot=a.createContext(void 0),Xe="chipBlockCrush_canvasOrientation",Gt=({children:o})=>{const[t,n]=a.useState(()=>{if(typeof window!="undefined"){const s=localStorage.getItem(Xe);if(s==="portrait"||s==="landscape")return s}return"landscape"});a.useEffect(()=>{localStorage.setItem(Xe,t)},[t]);const l=s=>{n(s)},r=()=>{n(s=>s==="landscape"?"portrait":"landscape")};return z.jsx(ot.Provider,{value:{orientation:t,toggleOrientation:r,setOrientation:l},children:o})},st=()=>{const o=a.useContext(ot);if(!o)throw new Error("useCanvasOrientation must be used within CanvasOrientationProvider");return o},gt="modulepreload",mt=function(o){return"/ChipBlockCrush/"+o},Ye={},we=function(t,n,l){if(!n||n.length===0)return t();const r=document.getElementsByTagName("link");return Promise.all(n.map(s=>{if(s=mt(s),s in Ye)return;Ye[s]=!0;const c=s.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(!!l)for(let f=r.length-1;f>=0;f--){const y=r[f];if(y.href===s&&(!c||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${s}"]${u}`))return;const d=document.createElement("link");if(d.rel=c?"stylesheet":gt,c||(d.as="script",d.crossOrigin=""),d.href=s,document.head.appendChild(d),c)return new Promise((f,y)=>{d.addEventListener("load",f),d.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${s}`)))})})).then(()=>t()).catch(s=>{const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=s,window.dispatchEvent(c),!c.defaultPrevented)throw s})},pt=(o,t)=>{const n=o[t];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((l,r)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(r.bind(null,new Error("Unknown variable dynamic import: "+t)))})},Ie=["ko","en","ja","zh"],St="ko",Ht={ko:"한국어",en:"English",ja:"日本語",zh:"中文"},ve={debug:(...o)=>{},info:(...o)=>console.info("[ChipBlockCrush]",...o),warn:(...o)=>console.warn("[ChipBlockCrush]",...o),error:(...o)=>console.error("[ChipBlockCrush]",...o)},Fe="language";class Ue{detectBrowserLanguage(){const t=navigator.language.split("-")[0];return Ie.includes(t)?t:St}getStoredLanguage(){try{return localStorage.getItem(Fe)}catch(t){return ve.error("Failed to get stored language",{error:t}),null}}setLanguage(t){if(Ie.includes(t))try{localStorage.setItem(Fe,t),window.dispatchEvent(new CustomEvent("languageChanged",{detail:t})),ve.debug("Language changed",{language:t})}catch(n){ve.error("Failed to set language",{error:n,language:t})}}getCurrentLanguage(){const t=this.getStoredLanguage();return t&&Ie.includes(t)?t:this.detectBrowserLanguage()}}const Le={},yt=()=>{const[o,t]=a.useState(()=>new Ue().getCurrentLanguage()),[n,l]=a.useState(null),[r,s]=a.useState(!0);return a.useEffect(()=>{(()=>We(void 0,null,function*(){s(!0);try{if(Le[o]){l(Le[o]),s(!1);return}const d=yield pt(Object.assign({"../locales/en.json":()=>we(()=>import("./en-b2856937.js"),[]),"../locales/ja.json":()=>we(()=>import("./ja-21955580.js"),[]),"../locales/ko.json":()=>we(()=>import("./ko-1b6ee49c.js"),[]),"../locales/zh.json":()=>we(()=>import("./zh-2511d938.js"),[])}),`../locales/${o}.json`);Le[o]=d.default,l(d.default)}catch(d){try{const f=yield we(()=>import("./ko-1b6ee49c.js"),[]);l(f.default)}catch(f){l({})}}finally{s(!1)}}))()},[o]),a.useEffect(()=>{const i=d=>{const f=d;f.detail&&(f.detail==="ko"||f.detail==="en"||f.detail==="ja"||f.detail==="zh")&&t(f.detail)};return window.addEventListener("languageChanged",i),()=>window.removeEventListener("languageChanged",i)},[]),{language:o,setLanguage:i=>{new Ue().setLanguage(i),(i==="ko"||i==="en"||i==="ja"||i==="zh")&&t(i)},t:i=>{if(r||!n)return i;const d=i.split(".");let f=n;for(const y of d)if(f=f==null?void 0:f[y],f===void 0)break;return(typeof f=="string"?f:i)||i},isLoading:r}},Ve="chipBlockCrush_",Ke={get(o,t={}){var l,r;const n=Ve+o;try{const s=localStorage.getItem(n);return s===null?(l=t.fallback)!=null?l:null:JSON.parse(s)}catch(s){return t.silent||ve.warn("storage get failed",n,s),(r=t.fallback)!=null?r:null}},set(o,t,n={}){const l=Ve+o;try{localStorage.setItem(l,JSON.stringify(t))}catch(r){n.silent||ve.warn("storage set failed",l,r)}}};class wt{constructor(){Pe(this,"enabled",!0);Pe(this,"ctx",null)}setEnabled(t){this.enabled=t}getContext(){return typeof window=="undefined"||!window.AudioContext?null:(this.ctx||(this.ctx=new window.AudioContext),this.ctx)}playClick(){if(!this.enabled)return;const t=this.getContext();if(!t)return;const n=()=>{try{const l=t.currentTime,r=t.createOscillator(),s=t.createGain();r.connect(s),s.connect(t.destination),r.type="sine",r.frequency.setValueAtTime(880,l),r.frequency.exponentialRampToValueAtTime(440,l+.05),s.gain.setValueAtTime(.12,l),s.gain.exponentialRampToValueAtTime(.001,l+.08),r.start(l),r.stop(l+.08)}catch(l){}};t.state==="suspended"?t.resume().then(n).catch(()=>{}):n()}playPlace(){if(!this.enabled)return;const t=this.getContext();if(!t)return;const n=()=>{try{const l=t.currentTime,r=t.createOscillator(),s=t.createGain();r.connect(s),s.connect(t.destination),r.type="sine",r.frequency.setValueAtTime(660,l),s.gain.setValueAtTime(.1,l),s.gain.exponentialRampToValueAtTime(.001,l+.06),r.start(l),r.stop(l+.06)}catch(l){}};t.state==="suspended"?t.resume().then(n).catch(()=>{}):n()}}const vt=new wt;const Re=[[[1]],[[1,1]],[[1],[1]],[[1,1,1]],[[1],[1],[1]],[[1,1],[1,0]],[[1,1],[0,1]],[[1,0],[1,1]],[[0,1],[1,1]],[[1,1],[1,1]],[[1,1,1,1]],[[1],[1],[1],[1]],[[1,1,1],[1,0,0]],[[1,0],[1,0],[1,1]],[[0,0,1],[1,1,1]],[[1,1],[0,1],[0,1]],[[1,1,1],[0,0,1]],[[0,1],[0,1],[1,1]],[[1,0,0],[1,1,1]],[[1,1],[1,0],[1,0]],[[1,1,1],[0,1,0]],[[1,0],[1,1],[1,0]],[[0,1,0],[1,1,1]],[[0,1],[1,1],[0,1]],[[1,1,0],[0,1,1]],[[0,1],[1,1],[1,0]],[[0,1,1],[1,1,0]],[[1,0],[1,1],[0,1]],[[1,0],[1,1],[1,1]],[[1,1,1],[1,1,0]],[[1,1],[1,1],[0,1]],[[0,1,1],[1,1,1]],[[1,1,0],[1,1,1]],[[1,1],[1,1],[1,0]],[[1,1,1],[0,1,1]],[[0,1],[1,1],[1,1]],[[1,1,1,1,1]],[[1],[1],[1],[1],[1]],[[0,1,0],[1,1,1],[0,1,0]],[[1,1,1],[0,1,0],[0,1,0]],[[0,0,1],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,1]],[[1,0,0],[1,1,1],[1,0,0]]];function Ct(o,t,n){t/=100,n/=100;const l=t*Math.min(n,1-n),r=i=>{const d=(i+o/30)%12;return n-l*Math.max(Math.min(d-3,9-d,1),-1)},s=Math.round(r(0)*255),c=Math.round(r(8)*255),u=Math.round(r(4)*255);return"#"+[s,c,u].map(i=>i.toString(16).padStart(2,"0")).join("")}const Rt=72,bt=72,qe=Array.from({length:Re.length},(o,t)=>Ct(t*360/Re.length,Rt,bt));function Je(o){return Math.abs(Math.floor(Math.sin(o)*1e6))%Re.length}function _e(o){return qe[o%qe.length]}const Oe=9,Ze=3,Et=10,Qe=[0,20,30,40,50,60,70,80,90,100];function et(o=Oe){return Array.from({length:o},()=>Array(o).fill(0))}function he(o,t,n,l){var u,i;const r=t.length,s=(i=(u=t[0])==null?void 0:u.length)!=null?i:0,c=o.length;if(n<0||l<0||n+r>c||l+s>c)return!1;for(let d=0;d<r;d++)for(let f=0;f<s;f++)if(t[d][f]&&o[n+d][l+f]!==0)return!1;return!0}const rt=63;function kt(o,t,n,l,r,s){var f,y;const c=o.map(k=>[...k]),u=t.length,i=(y=(f=t[0])==null?void 0:f.length)!=null?y:0,d=r<<6|s&rt;for(let k=0;k<u;k++)for(let R=0;R<i;R++)t[k][R]&&(c[n+k][l+R]=d);return c}function xt(o){return o>0?o&rt:0}function Be(o){var r,s;let t=0,n=0,l=0;for(let c=0;c<o.length;c++)for(let u=0;u<((s=(r=o[0])==null?void 0:r.length)!=null?s:0);u++)o[c][u]&&(t+=c,n+=u,l++);return l===0?{row:0,col:0}:{row:Math.floor(t/l),col:Math.floor(n/l)}}const Me=2;function tt(o,t,n,l){const r=Be(t),s=n-r.row,c=l-r.col;let u=null,i=1/0;for(let d=-Me;d<=Me;d++)for(let f=-Me;f<=Me;f++){const y=s+d,k=c+f;if(!he(o,t,y,k))continue;const R=y+r.row,H=k+r.col,A=Math.abs(R-n)+Math.abs(H-l);A<i&&(i=A,u={row:y,col:k})}return u}function Mt(o){const t=o.length,n=[],l=[];for(let r=0;r<t;r++){let s=!0,c=!0;for(let u=0;u<t;u++)o[r][u]===0&&(s=!1),o[u][r]===0&&(c=!1);s&&n.push(r),c&&l.push(r)}return{rows:n,cols:l}}function _t(o,t,n){const l=o.length,r=o.map(s=>[...s]);for(const s of t)for(let c=0;c<l;c++)r[s][c]=0;for(const s of n)for(let c=0;c<l;c++)r[c][s]=0;return r}function Tt(o,t){var r;const n=o*Et,l=(r=Qe[Math.min(t,Qe.length-1)])!=null?r:0;return n+l}function At(o,t){var l,r;const n=o.length;for(const s of t){const c=Re[s];if(!c)continue;const u=c.length,i=(r=(l=c[0])==null?void 0:l.length)!=null?r:0;for(let d=0;d<=n-u;d++)for(let f=0;f<=n-i;f++)if(he(o,c,d,f))return!0}return!1}function ze(o){var t;return(t=Re[o])!=null?t:null}const lt=16/9,ct=9/16,Pt=1200,Ce=280,It=Math.floor(Ce/lt),Lt=Math.floor(Ce/ct);function Ot(o,t,n,l){const s=Math.min(o/400,t/300,1.2),c=Math.max(28,36*s),u=Math.max(56,72*s),i=Math.max(56,70*s),d=Math.max(22,28*s),f=4,y=o-u-8*2,k=t-c-8*2,R=Math.min(y/n,k/n),H=R*2.8,A=Math.max(Math.max(44,R*1.8),Math.min(H,Math.min(o*.15,t*.18,120))),B=8+(y-R*n)/2,K=c+8+(k-R*n)/2,W={x:8,y:8,w:i,h:d},T=[],$=Math.max(8,Math.min(o*.02,24)),P=o-u+(u-A)/2-$;let X=c+8;for(let I=0;I<l;I++)T.push({x:P,y:X,w:A,h:A}),X+=A+f;return{padding:8,scale:s,topBarHeight:c,rightPanelWidth:u,menuRect:W,trayRects:T,offsetX:B,offsetY:K,cellSize:R,gridSize:n,traySlotSize:A}}const at=a.forwardRef(({grid:o,onCellClick:t,preview:n,score:l=0,scoreLabel:r,bestScore:s=0,bestScoreLabel:c,onBack:u,backLabel:i,placeHintLabel:d,currentBlockIndices:f=[],selectedIndex:y=null,onBlockTrayClick:k,onBlockTrayPointerDown:R,onLayout:H},A)=>{const{orientation:B}=st(),K=a.useRef(null),W=a.useRef(null),T=a.useRef(null),$=o.length,P=B==="landscape"?lt:ct,X=B==="landscape"?It:Lt,[I,q]=a.useState({w:Ce,h:X});a.useImperativeHandle(A,()=>({getCellFromPoint(e,m){const p=W.current;if(!p||!T.current)return null;const g=p.getBoundingClientRect(),b=g.width,E=g.height;if(b<=0||E<=0)return null;let h=e-g.left,L=m-g.top;if(B==="portrait"){const me=h;h=L,L=b-me}const x=T.current,S=Math.floor((h-x.offsetX)/x.cellSize),C=Math.floor((L-x.offsetY)/x.cellSize);return C>=0&&C<x.gridSize&&S>=0&&S<x.gridSize?{row:C,col:S}:null},getCellSize(){var e,m;return(m=(e=T.current)==null?void 0:e.cellSize)!=null?m:24}}),[B]);const te=a.useCallback((e,m,p)=>{var De,Ge;const g=B==="portrait"?p:m,b=B==="portrait"?m:p,E=Math.max(1,f.length),h=Ot(g,b,$,E);T.current=h,H==null||H({cellSize:h.cellSize}),B==="portrait"&&(e.save(),e.translate(m/2,p/2),e.rotate(Math.PI/2),e.translate(-p/2,-m/2));const{padding:L,scale:x,rightPanelWidth:S,menuRect:C,trayRects:me,offsetX:pe,offsetY:w}=h,N=8;e.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--canvas-bg").trim()||"#1a1a1a",e.fillRect(0,0,g,b);const G=document.documentElement.getAttribute("data-theme")==="light",J=G?"rgba(220, 222, 235, 0.95)":"rgba(40, 42, 62, 0.95)",F=G?"rgba(124, 138, 255, 0.55)":"rgba(168, 181, 255, 0.5)",Z=G?"rgba(0,0,0,0.03)":"rgba(255,255,255,0.04)",v=G?"rgba(0,0,0,0.12)":"rgba(255,255,255,0.22)",O=G?"#2d2d2d":"#e8e8e8",V=G?"rgba(168, 181, 255, 0.35)":"rgba(102, 126, 234, 0.4)",D=G?"rgba(124, 138, 255, 0.6)":"rgba(168, 181, 255, 0.6)",M=Math.max(10,12*x);e.font=`600 ${M}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.textAlign="left",e.textBaseline="middle",u&&i&&(e.fillStyle=V,e.strokeStyle=D,e.lineWidth=2,typeof e.roundRect=="function"?(e.beginPath(),e.roundRect(C.x,C.y,C.w,C.h,8),e.fill(),e.stroke()):(e.fillRect(C.x,C.y,C.w,C.h),e.strokeRect(C.x,C.y,C.w,C.h)),e.fillStyle=O,e.textAlign="center",e.fillText(i,C.x+C.w/2,C.y+C.h/2),e.textAlign="left");const _=C.x+C.w+L,se=C.y+C.h/2,fe=M+2;e.textAlign="left",e.fillStyle=O,e.fillText(r!=null?`${r}: ${l}`:String(l),_,se,m-_-S-L),c!=null&&e.fillText(`${c}: ${s}`,_,se+fe,m-_-S-L),f.forEach((Q,ee)=>{var Se,ye;const j=me[ee];if(!j)return;const Y=ze(Q);if(y===ee&&(e.fillStyle="rgba(168, 181, 255, 0.25)",e.strokeStyle="rgba(168, 181, 255, 0.8)",e.lineWidth=2,typeof e.roundRect=="function"&&(e.beginPath(),e.roundRect(j.x-2,j.y-2,j.w+4,j.h+4,10),e.fill(),e.stroke())),Y){const Te=Y.length,Ae=(ye=(Se=Y[0])==null?void 0:Se.length)!=null?ye:0,ae=Math.min((j.w-8)/Ae,(j.h-8)/Te,Math.max(14,j.w*.3)),it=j.x+(j.w-Ae*ae)/2,ut=j.y+(j.h-Te*ae)/2;e.fillStyle=_e(Q),e.strokeStyle="rgba(255,255,255,0.4)",e.lineWidth=1;for(let ke=0;ke<Te;ke++)for(let xe=0;xe<Ae;xe++)if(Y[ke][xe]){const He=it+xe*ae+1,$e=ut+ke*ae+1;e.fillRect(He,$e,ae-2,ae-2),e.strokeRect(He,$e,ae-2,ae-2)}}});const re=h.cellSize*$,Ee=h.cellSize*$,le=pe-2,de=w-2,je=re+4,Ne=Ee+4;e.beginPath(),typeof e.roundRect=="function"?e.roundRect(le,de,je,Ne,N):e.rect(le,de,je,Ne),e.fillStyle=J,e.fill(),e.strokeStyle=F,e.lineWidth=3,e.stroke();for(let Q=0;Q<$;Q++)for(let ee=0;ee<$;ee++){const j=pe+ee*h.cellSize,Y=w+Q*h.cellSize,ce=o[Q][ee];ce>0?(e.fillStyle=_e(xt(ce)),e.fillRect(j+2,Y+2,h.cellSize-4,h.cellSize-4),e.strokeStyle="rgba(255,255,255,0.35)",e.lineWidth=1,e.strokeRect(j+2,Y+2,h.cellSize-4,h.cellSize-4)):(e.fillStyle=Z,e.fillRect(j+1,Y+1,h.cellSize-2,h.cellSize-2),e.strokeStyle=v,e.lineWidth=1,e.strokeRect(j+1,Y+1,h.cellSize-2,h.cellSize-2))}if(n&&n.shape){const Q=n.colorIndex!==void 0?_e(n.colorIndex):"rgba(168, 181, 255, 0.6)";e.fillStyle=Q,e.globalAlpha=.7,e.strokeStyle="rgba(255,255,255,0.6)",e.lineWidth=2;const ee=n.shape.length,j=(Ge=(De=n.shape[0])==null?void 0:De.length)!=null?Ge:0;for(let Y=0;Y<ee;Y++)for(let ce=0;ce<j;ce++)if(n.shape[Y][ce]){const Se=pe+(n.col+ce)*h.cellSize+2,ye=w+(n.row+Y)*h.cellSize+2;e.fillRect(Se,ye,h.cellSize-4,h.cellSize-4),e.strokeRect(Se,ye,h.cellSize-4,h.cellSize-4)}e.globalAlpha=1}B==="portrait"&&e.restore()},[o,$,n,l,r,s,c,i,u,f,y,H,B]);a.useEffect(()=>{const e=K.current,m=W.current;if(!e||!m)return;const p=()=>{const b=Math.max(e.clientWidth||0,Ce),E=Math.max(e.clientHeight||0,X),h=Math.min(b,Pt),L=h/P;let x=h,S=L;E<L&&(S=E,x=S*P,x>b&&(x=b,S=x/P)),x=Math.max(Ce,Math.floor(x)),S=Math.max(X,Math.floor(S)),q({w:x,h:S})};p();const g=new ResizeObserver(p);return g.observe(e),()=>g.disconnect()},[P,X]),a.useEffect(()=>{const e=W.current;if(!e)return;const p=window.devicePixelRatio||1;e.width=I.w*p,e.height=I.h*p,e.style.width=`${I.w}px`,e.style.height=`${I.h}px`;const g=e.getContext("2d",{alpha:!0,willReadFrequently:!1});g&&(g.scale(p,p),te(g,I.w,I.h))},[I,te]),a.useEffect(()=>{const e=W.current;if(!e)return;const m=e.getContext("2d");if(!m)return;const p=parseInt(e.style.width||"0",10),g=parseInt(e.style.height||"0",10);p&&g&&te(m,p,g)},[o,te]);const ne=a.useCallback((e,m)=>{const p=W.current;if(!p)return null;const g=p.getBoundingClientRect(),b=g.width,E=g.height;if(b<=0||E<=0)return null;let h=e-g.left,L=m-g.top;if(B==="portrait"){const x=h;h=L,L=b-x}return{px:h,py:L}},[B]),be=a.useCallback(e=>{const m="touches"in e?e.touches[0].clientX:e.clientX,p="touches"in e?e.touches[0].clientY:e.clientY,g=ne(m,p);if(!g||!T.current||!R)return;const E=T.current.trayRects.findIndex(h=>g.px>=h.x&&g.px<=h.x+h.w&&g.py>=h.y&&g.py<=h.y+h.h);E>=0&&R(E,m,p)},[ne,R]),ue=a.useCallback((e,m)=>{const p=ne(e,m);if(!p)return;const{px:g,py:b}=p,E=T.current;if(!E)return;if(u&&i){const S=E.menuRect;if(g>=S.x&&g<=S.x+S.w&&b>=S.y&&b<=S.y+S.h){u();return}}const h=E.trayRects.findIndex(S=>g>=S.x&&g<=S.x+S.w&&b>=S.y&&b<=S.y+S.h);if(h>=0&&k){k(h);return}const L=Math.floor((g-E.offsetX)/E.cellSize),x=Math.floor((b-E.offsetY)/E.cellSize);t&&x>=0&&x<E.gridSize&&L>=0&&L<E.gridSize&&t(x,L)},[ne,u,i,k,t]),U=a.useCallback(e=>{ue(e.clientX,e.clientY)},[ue]),ie=a.useRef(null),oe=a.useCallback(e=>{ie.current={x:e.touches[0].clientX,y:e.touches[0].clientY,t:Date.now()}},[]),ge=a.useCallback(e=>{const m=ie.current;if(ie.current=null,!m||!e.changedTouches[0])return;const p=e.changedTouches[0].clientX-m.x,g=e.changedTouches[0].clientY-m.y;Date.now()-m.t<=400&&p*p+g*g<=400&&(e.preventDefault(),ue(e.changedTouches[0].clientX,e.changedTouches[0].clientY))},[ue]);return z.jsx("div",{ref:K,className:"game-canvas-wrapper","data-orientation":B,children:z.jsx("canvas",{ref:W,className:"game-canvas",onClick:U,onMouseDown:be,onTouchStart:e=>{be(e),oe(e)},onTouchEnd:ge,"aria-label":d})})});at.displayName="BlockCrushCanvas";const zt=a.memo(at),nt="highScore",Bt=({stageNumber:o,onBack:t})=>{const{t:n}=yt(),{orientation:l}=st(),r=a.useRef(null),[s,c]=a.useState(()=>et(Oe)),[u,i]=a.useState([]),[d,f]=a.useState(null),[y,k]=a.useState(0),[R,H]=a.useState(()=>{if(typeof window=="undefined")return 0;const w=Ke.get(nt,{fallback:0,silent:!0});return typeof w=="number"&&w>=0?w:0}),[A,B]=a.useState(!1),[K,W]=a.useState(1),[T,$]=a.useState(null),[P,X]=a.useState(null),[I,q]=a.useState(null),[te,ne]=a.useState(null),[be,ue]=a.useState(28),U=a.useRef(null),ie=a.useRef(null),oe=a.useRef(null),ge=a.useRef(null),e=a.useRef(null),m=a.useRef(null),p=a.useRef(null),g=8,b=o*1e3,E=a.useCallback(()=>{const w=[];for(let N=0;N<Ze;N++)w.push(Je(b+Date.now()+N));i(w)},[b]);a.useEffect(()=>{E()},[E]),a.useEffect(()=>{if(u.length===0)return;At(s,u)||B(!0)},[s,u]),a.useEffect(()=>{y<=R||(H(y),Ke.set(nt,y,{silent:!0}))},[y,R]);const h=a.useCallback((w,N,G)=>{const J=u[G],F=ze(J);if(!F||!he(s,F,w,N))return;vt.playPlace();let Z=kt(s,F,w,N,K,J);W(M=>M+1);let v=0;for(;;){const{rows:M,cols:_}=Mt(Z);if(M.length===0&&_.length===0)break;v+=M.length+_.length,Z=_t(Z,M,_)}const O=F.flat().filter(Boolean).length,V=Tt(O,v);k(M=>M+V),c(Z);const D=u.filter((M,_)=>_!==G);D.length<Ze&&D.push(Je(b+Date.now()+D.length)),i(D),f(null)},[s,u,K,b]),L=a.useCallback((w,N)=>{if(!A&&d!==null){h(w,N,d);return}},[A,d,h]),x=a.useCallback((w,N,G)=>{if(A)return;const J=u[w],F=ze(J);F&&($({x:N,y:G,index:w,shapeIdx:J,shape:F}),ge.current={index:w})},[u,A]),S=a.useCallback(w=>{A||f(N=>N===w?null:w)},[A]);oe.current=P,U.current=I,a.useEffect(()=>{if(!T&&!P)return;const w=(v,O)=>{const V=oe.current;if(V&&e.current?(e.current.style.left=`${v}px`,e.current.style.top=`${O}px`):ne({x:v,y:O}),T&&!P){const D=v-T.x,M=O-T.y;if(Math.sqrt(D*D+M*M)>=g){const _={index:T.index,shapeIdx:T.shapeIdx,shape:T.shape};X(_),oe.current=_,$(null),ge.current=null,ne({x:v,y:O})}}V&&(p.current={x:v,y:O},m.current==null&&(m.current=requestAnimationFrame(()=>{var se;m.current=null;const D=p.current,M=oe.current;if(!D||!M)return;const _=(se=r.current)==null?void 0:se.getCellFromPoint(D.x,D.y);if(_){ie.current=_;const fe=Be(M.shape),re=_.row-fe.row,Ee=_.col-fe.col,le=he(s,M.shape,re,Ee)?{row:re,col:Ee}:tt(s,M.shape,_.row,_.col);if(le){const de=U.current;(!de||de.row!==le.row||de.col!==le.col)&&(q(le),U.current=le)}else U.current!==null&&(q(null),U.current=null)}else U.current!==null&&(q(null),U.current=null)})))},N=v=>w(v.clientX,v.clientY),G=v=>{v.cancelable&&v.preventDefault(),v.touches.length>0&&w(v.touches[0].clientX,v.touches[0].clientY)},J=(v,O)=>{var _;const V=U.current,D=oe.current,M=ie.current;if(D){const se=v!=null&&O!=null,fe=se&&((_=r.current)==null?void 0:_.getCellFromPoint(v,O))!=null;if(!(se&&!fe)){let re=V&&he(s,D.shape,V.row,V.col)?V:M?tt(s,D.shape,M.row,M.col):null;re&&h(re.row,re.col,D.index)}}m.current!=null&&(cancelAnimationFrame(m.current),m.current=null),p.current=null,X(null),$(null),q(null),ne(null),U.current=null,ie.current=null,oe.current=null,ge.current=null},F=v=>{window.removeEventListener("mousemove",N),window.removeEventListener("mouseup",F),J(v.clientX,v.clientY)},Z=v=>{window.removeEventListener("touchmove",G,{capture:!0}),window.removeEventListener("touchend",Z,{capture:!0});const O=v.changedTouches[0];J(O==null?void 0:O.clientX,O==null?void 0:O.clientY)};return window.addEventListener("mousemove",N),window.addEventListener("mouseup",F),window.addEventListener("touchmove",G,{passive:!1,capture:!0}),window.addEventListener("touchend",Z,{capture:!0}),()=>{window.removeEventListener("mousemove",N),window.removeEventListener("mouseup",F),window.removeEventListener("touchmove",G,{capture:!0}),window.removeEventListener("touchend",Z,{capture:!0})}},[T,P,s,h]);const C=a.useCallback(w=>{ue(w.cellSize)},[]),me=a.useMemo(()=>!P||!I||!he(s,P.shape,I.row,I.col)?null:{shape:P.shape,row:I.row,col:I.col,colorIndex:P.shapeIdx},[P,I,s]),pe=()=>{c(et(Oe)),k(0),B(!1),f(null),X(null),q(null),W(1),E()};return z.jsxs("div",{className:"game-screen",children:[z.jsx("div",{className:`game-area ${A?"game-over":""}`,children:z.jsx("div",{className:"game-board",children:z.jsx(zt,{ref:r,grid:s,onCellClick:L,preview:me,onLayout:C,score:y,scoreLabel:n("game.score"),bestScore:R,bestScoreLabel:n("game.bestScore"),onBack:t,backLabel:n("game.backToStage"),placeHintLabel:n("game.placeHint"),currentBlockIndices:u,selectedIndex:d,onBlockTrayClick:S,onBlockTrayPointerDown:x})})}),P&&te&&typeof document!="undefined"&&ht.createPortal(z.jsx("div",{ref:e,className:"game-drag-ghost",style:{left:te.x,top:te.y,transform:l==="portrait"?"translate(-50%, -50%) rotate(90deg)":"translate(-50%, -50%)"},"aria-hidden":!0,children:z.jsx(jt,{shape:P.shape,colorIndex:P.shapeIdx,size:be})}),document.body),A&&z.jsx("div",{className:"game-overlay",children:z.jsxs("div",{className:"game-over-box",children:[z.jsx("h2",{children:n("game.gameOver")}),z.jsxs("p",{children:[n("game.score"),": ",y]}),z.jsxs("p",{className:"game-over-best",children:[n("game.bestScore"),": ",R]}),z.jsxs("div",{className:"game-over-buttons",children:[z.jsx("button",{type:"button",onClick:pe,children:n("game.playAgain")}),z.jsx("button",{type:"button",onClick:t,children:n("game.backToStage")})]})]})})]})};function jt({shape:o,colorIndex:t,size:n=24}){var T,$;const l=_e(t),r=o.length,s=($=(T=o[0])==null?void 0:T.length)!=null?$:0,c=n,u=s*c,i=r*c,d=Be(o),f=d.col*c+c/2,y=d.row*c+c/2,k=u/2-f,R=i/2-y,H=4,A=Math.min(0,k)-H,B=Math.min(0,R)-H,K=u+Math.abs(k)+H*2,W=i+Math.abs(R)+H*2;return z.jsx("svg",{width:K,height:W,viewBox:`${A} ${B} ${K} ${W}`,className:"block-preview-svg",children:z.jsx("g",{transform:`translate(${k}, ${R})`,children:o.map((P,X)=>P.map((I,q)=>I?z.jsx("rect",{x:q*c+1,y:X*c+1,width:c-1,height:c-1,fill:l,stroke:"rgba(255,255,255,0.4)",strokeWidth:1,rx:4},`${X}-${q}`):null))})})}const $t=Object.freeze(Object.defineProperty({__proto__:null,default:Bt},Symbol.toStringTag,{value:"Module"}));export{Re as B,Gt as C,$t as G,Ht as L,Ie as S,we as _,vt as a,st as b,_e as g,Ke as s,yt as u};
